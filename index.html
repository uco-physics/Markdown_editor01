<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown Editor</title>
  <!-- CDN依存 -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.7/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.10.0/lib/core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.10.0/lib/languages/markdown.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/libsodium-wrappers@0.7.13/dist/modules/libsodium-wrappers.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.10.0/styles/vs2015.min.css">
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\": \"Markdown Editor\",
    \"short_name\": \"MDEditor\",
    \"start_url\": \".\",
    \"display\": \"standalone\",
    \"background_color\": \"#1e1e1e\",
    \"theme_color\": \"#007acc\",
    \"icons\": [
      {\"src\": \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFAAAA////I4ozXgAAABhJREFUeNpiYGBgYGBhZmBgYGRgZGBgYAAAAPAABmWj9N4AAAAASUVORK5CYII=\", \"sizes\": \"32x32\", \"type\": \"image/png\"}
    ]
  }">
  <style>
    /* モダンなVSCode風デザイン */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1e1e1e; color: #d4d4d4; }
    #app { display: grid; grid-template-columns: 250px 1fr 1fr; height: 100vh; }
    #sidebar { background: #252526; padding: 10px; overflow-y: auto; }
    #editor { background: #1e1e1e; border: none; padding: 15px; font-size: 14px; color: #d4d4d4; resize: none; }
    #preview { background: #ffffff; color: #333; padding: 15px; overflow-y: auto; }
    .tree { list-style: none; padding-left: 15px; }
    .tree li { cursor: pointer; padding: 5px 0; }
    .tree li:hover { background: #333; }
    .resizer { width: 5px; background: #007acc; cursor: col-resize; }
    .resizer:hover { background: #00aaff; }
    .toolbar { background: #252526; padding: 5px; display: flex; gap: 5px; }
    .toolbar button { background: #007acc; color: #fff; border: none; padding: 5px 10px; cursor: pointer; }
    .toolbar button:hover { background: #00aaff; }
    .theme-toggle { position: fixed; top: 10px; right: 10px; }
    /* ライトテーマ */
    body.light { background: #ffffff; color: #333; }
    body.light #sidebar { background: #f3f3f3; }
    body.light #editor { background: #ffffff; color: #333; }
    body.light .toolbar { background: #f3f3f3; }
    body.light .tree li:hover { background: #e0e0e0; }
    /* モバイル対応 */
    @media (max-width: 768px) {
      #app { grid-template-columns: 1fr; grid-template-rows: auto auto auto; }
      #sidebar, #editor, #preview { height: 33vh; }
      .resizer { display: none; }
    }
  </style>
</head>
<body>
  <!-- UIレイアウト -->
  <div id="app">
    <div id="sidebar">
      <div class="toolbar">
        <button onclick="createFile()">New File</button>
        <button onclick="createFolder()">New Folder</button>
        <button onclick="uploadImage()">Upload Image</button>
      </div>
      <ul id="tree" class="tree"></ul>
    </div>
    <div class="resizer" id="sidebar-resizer"></div>
    <div id="editor-container">
      <div class="toolbar">
        <button onclick="undo()">Undo</button>
        <button onclick="redo()">Redo</button>
        <button onclick="save()">Save</button>
        <button onclick="exportFolder()">Export Folder</button>
        <button onclick="exportHtml()">Export HTML</button>
        <button onclick="exportSource()">Export Source</button>
      </div>
      <textarea id="editor"></textarea>
    </div>
    <div class="resizer" id="editor-resizer"></div>
    <div id="preview"></div>
  </div>
  <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>

  <script>
    // 初期化
    const db = new Dexie('MarkdownEditor');
    db.version(1).stores({
      files: 'path, content, type, created, updated',
      versions: 'id, path, content, timestamp',
      settings: 'key, value'
    });
    let currentPath = null;
    let undoStack = [];
    let redoStack = [];
    let autoSaveTimeout = null;

    // 暗号化準備
    let encryptionKey;
    async function initCrypto() {
      await sodium.ready;
      encryptionKey = sodium.crypto_secretbox_keygen();
    }
    initCrypto();

    // ディレクトリ操作
    async function loadTree() {
      const files = await db.files.toArray();
      const tree = {};
      files.forEach(file => {
        const parts = file.path.split('/');
        let current = tree;
        parts.forEach((part, i) => {
          if (!current[part]) current[part] = i === parts.length - 1 ? file : {};
          current = current[part];
        });
      });
      renderTree(tree, document.getElementById('tree'));
    }

    function renderTree(tree, ul, prefix = '') {
      ul.innerHTML = '';
      Object.keys(tree).sort().forEach(key => {
        const li = document.createElement('li');
        const item = tree[key];
        li.textContent = key;
        if (item.type === 'file') {
          li.onclick = () => openFile(prefix + key);
        } else {
          li.textContent += '/';
          li.onclick = () => li.querySelector('ul')?.classList.toggle('hidden');
          const subUl = document.createElement('ul');
          subUl.className = 'tree hidden';
          renderTree(item, subUl, prefix + key + '/');
          li.appendChild(subUl);
        }
        ul.appendChild(li);
      });
    }

    async function createFile() {
      const path = prompt('File path (e.g., /docs/note.md):');
      if (path) {
        await db.files.put({ path, content: '', type: 'file', created: Date.now(), updated: Date.now() });
        loadTree();
      }
    }

    async function createFolder() {
      const path = prompt('Folder path (e.g., /docs/):');
      if (path) {
        await db.files.put({ path, content: '', type: 'folder', created: Date.now(), updated: Date.now() });
        loadTree();
      }
    }

    async function uploadImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async () => {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = async () => {
          const base64 = reader.result;
          const path = `/images/${file.name}`;
          await db.files.put({ path, content: base64, type: 'file', created: Date.now(), updated: Date.now() });
          loadTree();
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    // エディタ操作
    async function openFile(path) {
      currentPath = path;
      const file = await db.files.get(path);
      const editor = document.getElementById('editor');
      editor.value = file?.content || '';
      undoStack = [];
      redoStack = [];
      renderPreview();
      hljs.highlightElement(editor);
    }

    function renderPreview() {
      const content = document.getElementById('editor').value;
      const html = marked.parse(content, {
        async: false,
        breaks: true,
        gfm: true,
        sanitizer: DOMPurify.sanitize
      });
      document.getElementById('preview').innerHTML = html;
      // 画像リンクをBase64に置換
      document.querySelectorAll('#preview img').forEach(img => {
        const src = img.getAttribute('src');
        db.files.get(src).then(file => {
          if (file?.content) img.src = file.content;
        });
      });
    }

    // バージョン管理
    function undo() {
      if (!undoStack.length) return;
      const current = document.getElementById('editor').value;
      redoStack.push(current);
      document.getElementById('editor').value = undoStack.pop();
      renderPreview();
    }

    function redo() {
      if (!redoStack.length) return;
      const current = document.getElementById('editor').value;
      undoStack.push(current);
      document.getElementById('editor').value = redoStack.pop();
      renderPreview();
    }

    // 保存
    async function save() {
      if (!currentPath) return;
      const content = document.getElementById('editor').value;
      undoStack.push(content);
      await db.files.update(currentPath, { content, updated: Date.now() });
      await db.versions.add({ path: currentPath, content, timestamp: Date.now() });
      renderPreview();
    }

    function autoSave() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(save, 500);
    }

    // エクスポート
    async function exportFolder() {
      const zip = new JSZip();
      const files = await db.files.toArray();
      files.forEach(file => {
        if (file.type === 'file') zip.file(file.path.slice(1), file.content);
      });
      const blob = await zip.generateAsync({ type: 'blob' });
      downloadFile(blob, 'markdown-editor.zip');
    }

    async function exportHtml() {
      const html = document.getElementById('preview').innerHTML;
      const blob = new Blob([html], { type: 'text/html' });
      downloadFile(blob, 'preview.html');
    }

    async function exportSource() {
      if (!currentPath) return;
      const file = await db.files.get(currentPath);
      const blob = new Blob([file.content], { type: 'text/plain' });
      downloadFile(blob, currentPath.split('/').pop());
    }

    function downloadFile(blob, name) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      a.click();
      URL.revokeObjectURL(url);
    }

    // テーマ切替
    function toggleTheme() {
      document.body.classList.toggle('light');
      const theme = document.body.classList.contains('light') ? 'light' : 'dark';
      localStorage.setItem('theme', theme);
    }

    // リサイズハンドラ
    function setupResizer(resizerId, target, direction) {
      const resizer = document.getElementById(resizerId);
      resizer.addEventListener('mousedown', e => {
        e.preventDefault();
        const startX = e.clientX;
        const startWidth = target.offsetWidth;
        const onMouseMove = e => {
          const delta = e.clientX - startX;
          target.style.width = `${startWidth + (direction === 'right' ? delta : -delta)}px`;
        };
        const onMouseUp = () => {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
          localStorage.setItem(resizerId, target.style.width);
        };
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
    }

    // 初期化
    window.onload = async () => {
      // テーマ復元
      const theme = localStorage.getItem('theme') || 'dark';
      if (theme === 'light') document.body.classList.add('light');

      // リサイズ設定
      setupResizer('sidebar-resizer', document.getElementById('sidebar'), 'right');
      setupResizer('editor-resizer', document.getElementById('editor-container'), 'right');

      // エディタイベント
      const editor = document.getElementById('editor');
      editor.addEventListener('input', () => {
        autoSave();
        renderPreview();
        hljs.highlightElement(editor);
      });

      // ショートカット
      editor.addEventListener('keydown', e => {
        if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
        if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
        if (e.ctrlKey && e.key === 's') { e.preventDefault(); save(); }
      });

      // ディレクトリ読み込み
      await loadTree();

      // Service Worker登録
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(console.error);
      }

      // 定期バックアップ
      setInterval(save, 5 * 60 * 1000);
    };

    // Service Worker（オフライン対応）
    const swCode = `
      self.addEventListener('install', e => {
        e.waitUntil(
          caches.open('markdown-editor').then(cache =>
            cache.addAll(['./'])
          )
        );
      });
      self.addEventListener('fetch', e => {
        e.respondWith(
          caches.match(e.request).then(response => response || fetch(e.request))
        );
      });
    `;
    const swBlob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker?.register(swUrl);
  </script>
</body>
</html>
